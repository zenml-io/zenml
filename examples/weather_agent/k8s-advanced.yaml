# Advanced Kubernetes Deployment Configuration for Weather Agent
#
# This is a PRODUCTION-READY configuration demonstrating all advanced features:
#
# ✅ Autoscaling (HPA) - 2 to 10 replicas based on CPU/memory
# ✅ High Availability - PodDisruptionBudget ensures min availability
# ✅ Ingress - Domain-based routing (weather.company.com)
# ✅ Health Probes - Aggressive readiness/liveness checks
# ✅ Pod Settings - Affinity, tolerations, volumes
# ✅ Labels & Annotations - For monitoring, cost tracking
# ✅ Strict Resource Validation - Fails if HPA/Ingress can't be created
# ✅ Automatic Retries - Built-in resilience for transient K8s API failures
#
# Prerequisites:
#   - Ingress controller (nginx) installed
#   - Metrics server installed (for HPA)
#   - Domain DNS configured to point to ingress
#
# To deploy:
#   zenml pipeline deploy weather_agent_pipeline -c k8s-advanced.yaml

parameters:
  city: "San Francisco"

settings:
  docker:
    parent_image: safoinme/zenml:deployer-0.4
    allow_download_from_artifact_store: false
    allow_including_files_in_images: true
  
  # Resource configuration - HPA will scale between min/max replicas
  resources:
    cpu_count: 1
    memory: "2GB"
    min_replicas: 2
    max_replicas: 10
  
  # ========================================================================
  # Advanced Kubernetes Deployer Configuration
  # ========================================================================
  deployer:
    # ========================================================================
    # Basic Configuration
    # ========================================================================
    namespace: weather-prod
    
    # Use ClusterIP since we're exposing via Ingress
    # (LoadBalancer would be redundant and costly)
    service_type: ClusterIP
    service_port: 8000
    
    # ⚠️ IMPORTANT: Strict mode ensures ALL additional resources apply successfully
    # If HPA or Ingress fails, entire deployment fails (production safety)
    # Set to false only for non-critical additional resources
    strict_additional_resources: true  # ✅ NEW: Fail-fast for production safety
    
    # ========================================================================
    # Health Probes
    # ========================================================================
    readiness_probe_path: /api/health
    readiness_probe_initial_delay: 5
    readiness_probe_period: 10
    readiness_probe_timeout: 3
    readiness_probe_failure_threshold: 3
    
    liveness_probe_path: /api/health
    liveness_probe_initial_delay: 20
    liveness_probe_period: 15
    liveness_probe_timeout: 5
    liveness_probe_failure_threshold: 3
    
    # ========================================================================
    # Labels and Annotations
    # ========================================================================
    labels:
      app: weather-agent
      environment: production
      version: "1.0"
      team: ml-platform
    
    annotations:
      # Prometheus monitoring
      prometheus.io/scrape: "true"
      prometheus.io/port: "8000"
      prometheus.io/path: "/metrics"
      # Custom annotations
      deployed-by: zenml
      contact: ml-team@company.com
    
    # ========================================================================
    # Advanced Pod Settings
    # ========================================================================
    pod_settings:
      # Custom labels (merged with deployer labels)
      labels:
        cost-center: ml-ops
        data-classification: public
      
      # Pod annotations (for things like Istio, Linkerd, etc.)
      annotations:
        sidecar.istio.io/inject: "false"  # Disable service mesh if not needed
      
      # Node affinity - prefer nodes with GPU or high memory
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: node-type
                    operator: In
                    values:
                      - compute-optimized
                      - memory-optimized
      
      # Tolerations - allow scheduling on tainted nodes
      tolerations:
        - key: "dedicated"
          operator: "Equal"
          value: "ml-workloads"
          effect: "NoSchedule"
      
      # Node selector - simple node selection
      node_selector:
        disktype: ssd
        region: us-west
      
      # Volumes - persistent storage example
      volumes:
        - name: model-cache
          emptyDir:
            sizeLimit: "10Gi"
        - name: config
          configMap:
            name: weather-config
            optional: true
      
      # Volume mounts
      volume_mounts:
        - name: model-cache
          mountPath: /app/model-cache
        - name: config
          mountPath: /app/config
          readOnly: true
      
      # Host aliases - for custom DNS resolution
      host_aliases:
        - ip: "10.0.0.1"
          hostnames:
            - "internal-api.company.local"
    
    # ========================================================================
    # Image Configuration
    # ========================================================================
    image_pull_policy: IfNotPresent
    image_pull_secrets:
      - dockerhub-secret
    
    # ========================================================================
    # Additional Kubernetes Resources (Ingress, HPA, PDB)
    # ========================================================================
    # Deploy additional resources alongside Deployment/Service
    # 
    # ✅ Supports Jinja2 templating: {{namespace}}, {{service_name}}, {{labels}}, etc.
    # ✅ Multi-document YAML: Separate resources with ---
    # ✅ Strict validation: With strict_additional_resources=true, deployment fails
    #    if any resource fails (production safety!)
    #
    # Available files:
    #   - k8s-resources-simple.yaml    : Ingress, HPA, PDB (realistic, tested)
    #   - k8s-additional-resources.yaml: Full production stack (requires Prometheus Operator)
    additional_resources:
      - ./k8s-resources-simple.yaml
    
    # ========================================================================
    # Development/Debug Settings
    # ========================================================================
    save_manifests: true    # ✅ Saves manifests to .zenml-deployments/ for inspection
    print_manifests: false  # Set to true to print manifests to console (verbose!)
    
    # ========================================================================
    # Timeouts & Intervals
    # ========================================================================
    # We're using ClusterIP (no LoadBalancer), so skip LB timeout
    wait_for_load_balancer_timeout: 0
    
    # Check deployment readiness every 2 seconds
    deployment_ready_check_interval: 2