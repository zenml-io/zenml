import{j as e}from"./@radix-sxciy0xP.js";import{z as u,a as v,C as y,u as Q,F as V,t as q}from"./@zod-3snSrKBm.js";import{B as b,p as z,e as S,ak as C,al as w,am as P,an as F,ao as I,ap as j,V as _,a2 as B,W as L,w as T,ai as H,r as M,k as U,I as A}from"./index-Duh0NHGE.js";import{c as k}from"./@react-router-B8Rvl3f4.js";import{g as E}from"./name-Bg7MBXU_.js";import{k as R,h as D}from"./@tanstack-BjpQvXOk.js";import{a as K}from"./all-pipeline-runs-query-FKKPMR3t.js";import{f as O}from"./pipeline-run-detail-query-CNnwlINY.js";import{u as W}from"./update-snapshot-C6K2dsBf.js";function Y({isPending:s}){const n=k();return e.jsxs("div",{className:"flex items-center justify-end gap-2 p-5",children:[e.jsx(b,{type:"button",onClick:()=>n(-1),intent:"secondary",size:"md",children:"Cancel"}),e.jsxs(b,{type:"submit",size:"md",disabled:s,children:[s&&e.jsx("div",{className:"h-4 w-4 animate-spin rounded-rounded border-2 border-theme-text-negative border-b-theme-text-brand"}),"Create Snapshot"]})]})}function $(){return e.jsx("div",{className:"px-5 py-3",children:e.jsx("h1",{className:"text-display-xs font-semibold",children:"Create Snapshot"})})}const G=u.object({name:u.string().min(1,"Name is required"),pipeline:u.string().uuid("Invalid pipeline ID"),run:u.string().min(1,"Run is required")});function J({pipeline:s}){var l;const{control:n,resetField:c}=v(),i=R({...z.pipelineListInfinite({sort_by:"desc:latest_run"}),throwOnError:!0});if(i.isPending)return e.jsx(S,{className:"h-7 w-[300px]"});if(i.isError)return e.jsx("p",{children:"Error fetching pipelines"});const d=(l=i.data)==null?void 0:l.pages.flatMap(a=>a.items);return e.jsx(y,{control:n,name:"pipeline",render:({field:{onChange:a,ref:r,...o}})=>e.jsxs(C,{disabled:!!s,...o,onValueChange:t=>{c("run"),a(t)},children:[e.jsx(w,{ref:r,className:"border border-theme-border-moderate text-text-md disabled:bg-neutral-100 data-[error=true]:border-error-500",children:e.jsx("div",{className:"truncate",children:e.jsx(P,{placeholder:"Select a pipeline"})})}),e.jsx(F,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs(I,{viewportClassName:"max-h-[300px]",children:[s&&e.jsx(j,{className:"flex items-center gap-1",value:s.id,children:e.jsx(g,{name:s.name})},s.id),!s&&d.map(t=>e.jsx(j,{value:t.id,children:e.jsx(g,{name:t.name})},t.id))]}),i.hasNextPage&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-[1px] fill-theme-border-moderate"}),e.jsx("button",{type:"button",onClick:()=>i.fetchNextPage(),className:"flex w-full rounded-sm bg-theme-surface-primary px-2 py-1 hover:bg-theme-surface-tertiary",children:e.jsxs("div",{className:"flex items-center gap-1",children:[i.isFetchingNextPage&&e.jsx("div",{role:"alert","aria-busy":"true",className:"full h-[20px] w-[20px] animate-spin rounded-rounded border-2 border-theme-text-negative border-b-theme-text-brand"}),"Load more"]})})]})]})})]})})}function g({name:s}){return e.jsxs("div",{className:"flex items-center gap-1 text-text-md",children:[e.jsx(_,{className:"size-4 shrink-0 fill-primary-400"}),e.jsx("div",{className:"truncate",children:s})]})}function X({run:s}){var o;const{watch:n,control:c,setValue:i,getValues:d}=v(),l=n("pipeline"),a=R({...K({params:{pipeline_id:l,sort_by:"desc:created"}})});if(a.isPending)return e.jsx(S,{className:"h-7 w-[300px]"});if(a.isError)return e.jsx("p",{children:"Error fetching runs"});const r=(o=a.data)==null?void 0:o.pages.flatMap(t=>t.items);return e.jsx(y,{control:c,name:"run",render:({field:{onChange:t,ref:x,...p}})=>{var h;return e.jsxs(C,{disabled:!!s||!l,...p,onValueChange:m=>{d("name")||i("name",E()),t(m)},children:[e.jsx(w,{ref:x,className:"border border-theme-border-moderate text-text-md disabled:bg-neutral-100 data-[error=true]:border-error-500",children:e.jsx("div",{className:"truncate",children:e.jsx(P,{placeholder:"Select a run"})})}),e.jsx(F,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs(I,{viewportClassName:"max-h-[300px]",children:[s&&e.jsx(j,{value:s.id,children:e.jsx(N,{name:s.name,status:((h=s.body)==null?void 0:h.status)??null})}),!s&&r.map(m=>{var f;return e.jsx(j,{value:m.id,children:e.jsx(N,{name:m.name,status:((f=m.body)==null?void 0:f.status)??null})},m.id)})]}),a.hasNextPage&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-[1px] fill-theme-border-moderate"}),e.jsx("button",{type:"button",onClick:()=>a.fetchNextPage(),className:"flex w-full rounded-sm bg-theme-surface-primary px-2 py-1 hover:bg-theme-surface-tertiary",children:e.jsxs("div",{className:"flex items-center gap-1",children:[a.isFetchingNextPage&&e.jsx("div",{role:"alert","aria-busy":"true",className:"full h-[20px] w-[20px] animate-spin rounded-rounded border-2 border-theme-text-negative border-b-theme-text-brand"}),"Load more"]})})]})]})})]})}})}function N({name:s,status:n}){return e.jsxs("div",{className:"flex items-center gap-1 text-text-md",children:[e.jsx(B,{className:`h-4 w-4 shrink-0 ${L(n)}`}),e.jsx("div",{className:"truncate",children:s})]})}function Z(s){const n=k(),c=D(),{toast:i}=T(),{mutate:d,isPending:l}=W({onSuccess(r){c.invalidateQueries({queryKey:[...H.all,r.id]}),n(M.projects.snapshots.detail.overview(r.id))},onError(r){i({status:"error",description:r instanceof Error?r.message:"Failed to create snapshot",rounded:!0})}});async function a({name:r,run:o}){var x,p;if(s!==null){d({snapshotId:s,payload:{name:r}});return}let t;try{t=(p=(x=(await O({runId:o})).resources)==null?void 0:x.snapshot)==null?void 0:p.id}catch{i({status:"error",emphasis:"subtle",description:"Failed to fetch run",rounded:!0});return}if(!t)return i({status:"error",emphasis:"subtle",description:"Snapshot not found",rounded:!0});d({snapshotId:t,payload:{name:r}})}return{handleCreateSnapshot:a,isPending:l}}function de({run:s}){var l,a,r,o,t;const n=Q({resolver:q(G),defaultValues:{name:s!=null&&s.name?E():"",pipeline:((a=(l=s==null?void 0:s.resources)==null?void 0:l.pipeline)==null?void 0:a.id)||"",run:(s==null?void 0:s.id)||""}}),{handleCreateSnapshot:c,isPending:i}=Z(((o=(r=s==null?void 0:s.resources)==null?void 0:r.snapshot)==null?void 0:o.id)||null),d=(t=s==null?void 0:s.resources)==null?void 0:t.pipeline;return e.jsx(U,{children:e.jsx(V,{...n,children:e.jsxs("form",{className:"divide-y divide-theme-border-moderate",onSubmit:n.handleSubmit(c),children:[e.jsx($,{}),e.jsxs("div",{className:"space-y-5 p-5",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold",children:"Select a name for your Snapshot"}),e.jsx("p",{className:"text-text-sm text-theme-text-secondary",children:"You can keep the suggested name or create your own."})]}),e.jsx(A,{className:"w-full",...n.register("name")}),e.jsx("div",{className:"h-[1px] bg-theme-border-moderate"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold",children:"Pipeline Settings"}),e.jsx("p",{className:"text-text-sm text-theme-text-secondary",children:"Select a pipeline and a pipeline run to create your snapshot"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-text-sm",children:"Pipeline"}),e.jsx(J,{pipeline:d||void 0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-text-sm",children:"Run"}),e.jsx(X,{run:s||void 0})]})]}),e.jsx(Y,{isPending:i})]})})})}export{de as C};
