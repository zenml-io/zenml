{#
  Kubernetes Deployment Template
  
  This template creates a Deployment resource for running containerized workloads.
  Users can override this template by providing their own deployment.yaml.j2 in
  the custom templates directory.
  
  Required context variables:
    - name: Deployment name
    - namespace: Kubernetes namespace
    - image: Container image
    - replicas: Number of replicas
    
  Optional context variables:
    - labels: Additional labels
    - service_account_name: Service account
    - image_pull_policy: Image pull policy
    - image_pull_secrets: List of image pull secret names
    - command: Container command override
    - args: Container args override
    - env: Environment variables dict
    - resources: Resource requests/limits dict
    - pod_settings: KubernetesPodSettings dict
    - security_context: Security context
    
  Built-in defaults (hardcoded in template):
    - Health probes: /api/health with standard timings
    - Override via custom_templates_dir to customize
#}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ name | k8s_name }}
  namespace: {{ namespace }}
  labels:
    app: {{ name | k8s_name }}
    managed-by: zenml
    {% if labels %}
    {% for key, value in labels.items() %}
    {{ key }}: {{ value | k8s_label_value | tojson }}
    {% endfor %}
    {% endif %}
spec:
  replicas: {{ replicas | default(1) }}
  selector:
    matchLabels:
      app: {{ name | k8s_name }}
  template:
    metadata:
      labels:
        app: {{ name | k8s_name }}
        managed-by: zenml
        {% if labels %}
        {% for key, value in labels.items() %}
        {{ key }}: {{ value | k8s_label_value | tojson }}
        {% endfor %}
        {% endif %}
        {% if pod_settings and pod_settings.labels %}
        {% for key, value in pod_settings.labels.items() %}
        {{ key }}: {{ value | k8s_label_value | tojson }}
        {% endfor %}
        {% endif %}
      {% if annotations or (pod_settings and pod_settings.annotations) %}
      annotations:
        {% if annotations %}
        {% for key, value in annotations.items() %}
        {{ key }}: {{ value | tojson }}
        {% endfor %}
        {% endif %}
        {% if pod_settings and pod_settings.annotations %}
        {% for key, value in pod_settings.annotations.items() %}
        {{ key }}: {{ value | tojson }}
        {% endfor %}
        {% endif %}
      {% endif %}
    spec:
      {% if service_account_name %}
      serviceAccountName: {{ service_account_name }}
      {% endif %}
      
      {% if image_pull_secrets %}
      imagePullSecrets:
      {% for secret in image_pull_secrets %}
        - name: {{ secret }}
      {% endfor %}
      {% endif %}
      
      {% if pod_settings and pod_settings.node_selectors %}
      nodeSelector:
      {% for key, value in pod_settings.node_selectors.items() %}
        {{ key }}: {{ value | tojson }}
      {% endfor %}
      {% endif %}
      
      {% if pod_settings and pod_settings.affinity %}
      affinity: {{ pod_settings.affinity | to_yaml | indent(8) }}
      {% endif %}
      
      {% if pod_settings and pod_settings.tolerations %}
      tolerations: {{ pod_settings.tolerations | to_yaml | indent(8) }}
      {% endif %}
      
      {% if pod_settings and pod_settings.scheduler_name %}
      schedulerName: {{ pod_settings.scheduler_name }}
      {% endif %}
      
      {% if pod_settings and pod_settings.host_ipc %}
      hostIPC: true
      {% endif %}
      
      containers:
      - name: main
        image: {{ image }}
        imagePullPolicy: {{ image_pull_policy | default("IfNotPresent") }}
        
        {% if command %}
        command: {{ command | to_yaml | indent(10) }}
        {% endif %}
        
        {% if args %}
        args: {{ args | to_yaml | indent(10) }}
        {% endif %}
        
        {% if env %}
        env:
        {% for key, value in env.items() %}
          - name: {{ key }}
            value: {{ value | tojson }}
        {% endfor %}
        {% endif %}
        
        {% if pod_settings and pod_settings.env %}
        {% if not env %}
        env:
        {% endif %}
        {% for env_var in pod_settings.env %}
          - {{ env_var | to_yaml | indent(12) }}
        {% endfor %}
        {% endif %}
        
        {% if pod_settings and pod_settings.env_from %}
        envFrom: {{ pod_settings.env_from | to_yaml | indent(10) }}
        {% endif %}
        
        {% if resources %}
        resources:
          {% if resources.requests %}
          requests:
          {% for key, value in resources.requests.items() %}
            {{ key }}: {{ value | tojson }}
          {% endfor %}
          {% endif %}
          {% if resources.limits %}
          limits:
          {% for key, value in resources.limits.items() %}
            {{ key }}: {{ value | tojson }}
          {% endfor %}
          {% endif %}
        {% endif %}
        
        readinessProbe:
          httpGet:
            path: {{ readiness_probe_path }}
            port: {{ probe_port }}
          initialDelaySeconds: {{ readiness_probe_initial_delay }}
          periodSeconds: {{ readiness_probe_period }}
          timeoutSeconds: {{ readiness_probe_timeout }}
          failureThreshold: {{ readiness_probe_failure_threshold }}
        
        livenessProbe:
          httpGet:
            path: {{ liveness_probe_path }}
            port: {{ probe_port }}
          initialDelaySeconds: {{ liveness_probe_initial_delay }}
          periodSeconds: {{ liveness_probe_period }}
          timeoutSeconds: {{ liveness_probe_timeout }}
          failureThreshold: {{ liveness_probe_failure_threshold }}
        
        {% if pod_settings and pod_settings.volume_mounts %}
        volumeMounts: {{ pod_settings.volume_mounts | to_yaml | indent(10) }}
        {% endif %}
        
        {% if security_context %}
        securityContext:
          privileged: {{ security_context.privileged | default(false) }}
        {% endif %}
      
      {% if pod_settings and pod_settings.volumes %}
      volumes: {{ pod_settings.volumes | to_yaml | indent(8) }}
      {% endif %}
      
      {% if pod_settings and pod_settings.additional_pod_spec_args %}
      {# Allow arbitrary pod spec overrides #}
      {% for key, value in pod_settings.additional_pod_spec_args.items() %}
      {{ key }}: {{ value | to_yaml | indent(6) }}
      {% endfor %}
      {% endif %}
{#
Advanced Customization Examples:
-------------------------------
Override this template by placing a custom deployment.yaml.j2 in your
custom_templates_dir. Below are examples of additional configurations:

1. Pod Annotations (e.g., for Prometheus scraping):
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8000"
        prometheus.io/path: "/metrics"

2. Init Containers (for setup tasks):
    spec:
      initContainers:
      - name: setup
        image: busybox
        command: ['sh', '-c', 'echo "Initializing..."']

3. Resource Limits (CPU/Memory):
    resources:
      requests:
        cpu: "500m"
        memory: "256Mi"
      limits:
        cpu: "2000m"
        memory: "1Gi"

4. Security Context (run as non-root):
    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      fsGroup: 1000
      seccompProfile:
        type: RuntimeDefault

5. Lifecycle Hooks (pre-stop graceful shutdown):
    lifecycle:
      preStop:
        exec:
          command: ["/bin/sh", "-c", "sleep 15"]

6. Startup Probe (for slow-starting containers):
    startupProbe:
      httpGet:
        path: /health
        port: 8000
      failureThreshold: 30
      periodSeconds: 10

All context variables available:
- name, namespace, labels, annotations
- image, image_pull_policy, image_pull_secrets
- replicas, service_account_name
- command, args, env
- resources, readiness_probe, liveness_probe
- pod_settings, security_context
#}

