---
name: Validate changelog.json
on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    paths: [changelog.json]
concurrency:
  # New commit on branch cancels running workflows of the same branch
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  verify-changelog-json:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    outputs:
      exit_code: ${{ steps.capture-outcome.outputs.exit_code }}
    steps:
      - uses: actions/checkout@50fbc622fc4ef5163becd7fab6573eac35f8462e  # v1
      - name: Validate changelog.json against announcement-schema.json
        id: validate-changelog
        uses: cardinalby/schema-validator-action@77eb17b070f282db4680215551cae4d9c379f2f4  # v3
        continue-on-error: true
        with:
          file: ./changelog.json
          schema: ./docs/changelog-items/announcement-schema.json
      - name: Capture validation outcome
        id: capture-outcome
        run: |
          if [ "${STEPS_VALIDATE_CHANGELOG_OUTCOME}" = "failure" ]; then
            echo "exit_code=1" >> $GITHUB_OUTPUT
          else
            echo "exit_code=0" >> $GITHUB_OUTPUT
          fi
        env:
          STEPS_VALIDATE_CHANGELOG_OUTCOME: ${{ steps.validate-changelog.outcome }}
  post-summary:
    needs: [verify-changelog-json]
    if: always() && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Create Summary
        id: create-summary
        run: |
          echo "# Changelog Validation Results" >> $GITHUB_STEP_SUMMARY

          # Create summary content for PR comment
          cat << 'EOL' > comment_beginning.txt
          ## Changelog Validation Results
          EOL

          # Check validation outcome
          if [[ "${NEEDS_VERIFY_CHANGELOG_JSON_OUTPUTS_EXIT_CODE}" != "0" ]]; then
            echo "❌ **Changelog validation failed**" >> $GITHUB_STEP_SUMMARY
            echo "The changelog.json file does not conform to the required schema structure." >> $GITHUB_STEP_SUMMARY
            cat << 'EOL' > comment_body.txt
          ❌ **Changelog validation failed**
          The `changelog.json` file does not conform to the required schema structure.
          Please review the [changelog documentation](https://github.com/${{ github.repository }}/blob/${GITHUB_BASE_REF}/docs/changelog-items/info.md) for guidance on the proper structure and required fields.
          EOL
            FAILED=true
          else
            echo "✅ **Changelog validation passed**" >> $GITHUB_STEP_SUMMARY
            cat << 'EOL' > comment_body.txt
          ✅ **Changelog validation passed**
          The `changelog.json` file conforms to the required schema structure.
          EOL
            FAILED=false
          fi

          # Add timestamp
          cat << EOL > comment_footer.txt
          <sub>Last checked: $(date -u '+%Y-%m-%d %H:%M:%S UTC')</sub>
          EOL

          # Combine all parts
          cat comment_beginning.txt comment_body.txt comment_footer.txt > full_comment.txt

          # Save comment body to output
          echo "comment_body<<EOF" >> $GITHUB_OUTPUT
          cat full_comment.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Save failed status to output
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
        env:
          NEEDS_VERIFY_CHANGELOG_JSON_OUTPUTS_EXIT_CODE: ${{ needs.verify-changelog-json.outputs.exit_code }}
      - name: Find Comment
        uses: peter-evans/find-comment@3eae4d37986fb5a8592848f6a574fdf654e61f9e  # v3
        if: github.event_name == 'pull_request'
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: github-actions[bot]
          body-includes: Changelog Validation Results
      - name: Create or Update Comment
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043  # v4
        if: github.event_name == 'pull_request'
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.create-summary.outputs.comment_body }}
          edit-mode: replace
      - name: Report Validation Status
        if: steps.create-summary.outputs.failed == 'true'
        run: |-
          echo "::error::Changelog validation failed. Please fix the issues."
          exit 1
